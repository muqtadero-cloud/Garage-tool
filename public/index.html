<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Garage Contract Assistant</title>
  
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', 'Roboto', sans-serif;
      background: var(--bg-main);
      margin: 0;
      line-height: 1.5;
      display: flex;
      min-height: 100vh;
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Sidebar - Modern & Clean with Collapse */
    .sidebar {
      width: 320px;
      background: var(--sidebar-bg);
      border-right: 1px solid var(--sidebar-border);
      padding: 0;
      overflow-y: auto;
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      height: 100vh;
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .sidebar.collapsed {
      width: 70px;
    }
    
    .sidebar.collapsed .brand-text {
      display: none;
    }
    
    .sidebar.collapsed #uploadForm {
      display: none !important;
    }
    
    .sidebar.collapsed .sidebar-collapse-btn i {
      transform: rotate(180deg);
    }
    
    /* Sidebar Header - Netflix Style */
    .sidebar-header {
      padding: 1.25rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      background: var(--bg-card);
    }
    
    .sidebar.collapsed .sidebar-header {
      flex-direction: column;
      gap: 0.75rem;
      padding: 1rem 0.5rem;
    }
    
    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 0.5rem;
      border-radius: 8px;
    }
    
    .sidebar.collapsed .sidebar-brand {
      padding: 0.375rem;
    }
    
    .sidebar-brand:hover {
      background: var(--bg-subtle);
    }
    
    .brand-icon {
      font-size: 1.5rem;
      line-height: 1;
    }
    
    .brand-text {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.02em;
      transition: opacity 0.2s;
      white-space: nowrap;
    }
    
    .sidebar-collapse-btn {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.375rem 0.5rem;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .sidebar-collapse-btn:hover {
      background: var(--bg-subtle);
      border-color: var(--border-hover);
      color: var(--text-primary);
    }
    
    .sidebar-collapse-btn i {
      font-size: 1rem;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    #uploadForm {
      padding: 1.5rem 1.25rem;
    }
    
    .sidebar h2 {
      font-size: 1.25rem;
      margin: 0 0 0.5rem 0;
      color: #fff;
    }
    
    .sidebar-subtitle {
      font-size: 0.813rem;
      color: #a0aec0;
      margin-bottom: 1.5rem;
    }
    
    .sidebar-section {
      margin-bottom: 1.5rem;
    }
    
    .sidebar-section label {
      display: block;
      font-size: 0.813rem;
      font-weight: 600;
      color: #e2e8f0;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .sidebar input,
    .sidebar select {
      width: 100%;
      padding: 0.625rem;
      border: 1px solid #4a5568;
      border-radius: 6px;
      background: #1a202c;
      color: white;
      font-size: 0.875rem;
    }
    
    .sidebar input:focus,
    .sidebar select:focus {
      outline: none;
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
    }
    
    .sidebar-divider {
      height: 1px;
      background: #4a5568;
      margin: 1.5rem 0;
    }
    
    /* Main Content */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      width: 100%;
    }
    
    .container {
      max-width: none;
      width: 100%;
      margin: 0;
      padding: 0;
    }
    
    h1 {
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
      color: #1a202c;
    }
    
    .subtitle {
      color: #718096;
      margin-bottom: 2rem;
      font-size: 0.95rem;
    }
    
    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
      overflow: hidden;
    }
    
    .card-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid #e2e8f0;
      font-weight: 600;
      color: #2d3748;
    }
    
    .card-body {
      padding: 1.5rem;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: #4a5568;
      margin-bottom: 0.375rem;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 0.875rem;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }
    
    textarea {
      min-height: 80px;
      resize: vertical;
      font-family: inherit;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
    }
    
    textarea:hover {
      border-color: var(--border-hover);
    }
    
    .btn {
      padding: 0.625rem 1.25rem;
      border: none;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #4299e1;
      color: white;
    }
    
    .btn-primary:hover {
      background: #3182ce;
    }
    
    .btn-success {
      background: #48bb78;
      color: white;
    }
    
    .btn-success:hover {
      background: #38a169;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .alert {
      padding: 0.875rem 1rem;
      border-radius: 6px;
      margin-top: 1rem;
      font-size: 0.875rem;
      display: none;
    }
    
    .alert.show { display: block; }
    .alert-info { background: #bee3f8; color: #2c5282; }
    .alert-success { background: #c6f6d5; color: #22543d; }
    .alert-error { background: #fed7d7; color: #742a2a; }
    
    /* Schedule Items */
    .schedule-item {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: 1rem;
      overflow: hidden;
    }
    
    .schedule-header {
      padding: 0.875rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      transition: background 0.15s ease;
    }
    
    .schedule-header:hover {
      background: var(--bg-subtle);
    }
    
    .schedule-header .toggle-icon {
      width: 24px;
      height: 24px;
      background: transparent;
      color: var(--text-secondary);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.125rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .schedule-header:hover .toggle-icon {
      background: var(--bg-subtle);
      color: var(--primary);
    }
    
    .schedule-item.open .toggle-icon {
      transform: rotate(90deg);
      color: var(--primary);
    }
    
    .schedule-info {
      flex: 1;
    }
    
    .schedule-name {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.875rem;
      margin-bottom: 0.125rem;
    }
    
    .schedule-meta {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .badge {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.688rem;
      font-weight: 600;
    }
    
    .badge-high { background: #c6f6d5; color: #22543d; }
    .badge-medium { background: #feebc8; color: #7c2d12; }
    .badge-low { background: #fed7d7; color: #742a2a; }
    .badge-none { background: #e2e8f0; color: #4a5568; }
    
    .schedule-content {
      display: none;
      padding: 1.25rem;
    }
    
    .schedule-item.open .schedule-content {
      display: block;
    }
    
    /* Sections */
    .section {
      margin-bottom: 1.5rem;
    }
    
    .section-title {
      font-size: 0.938rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.75rem;
      letter-spacing: -0.01em;
    }
    
    .evidence-box {
      background: var(--bg-card);
      border-left: 3px solid var(--primary);
      padding: 1rem 1.25rem;
      margin-bottom: 0.875rem;
      border-radius: 8px;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .evidence-box:hover {
      box-shadow: var(--shadow-md);
      border-left-color: var(--primary-hover);
    }
    
    .evidence-header {
      font-size: 0.813rem;
      color: var(--primary);
      font-weight: 500;
      margin-bottom: 0.5rem;
      letter-spacing: -0.01em;
    }
    
    .evidence-text {
      font-size: 0.875rem;
      color: var(--text-primary);
      line-height: 1.6;
    }
    
    .reasoning-box {
      background: #fffaf0;
      border-left: 3px solid #ed8936;
      padding: 0.875rem 1rem;
      margin-bottom: 1rem;
      border-radius: 4px;
    }
    
    .reasoning-text {
      font-size: 0.875rem;
      color: #744210;
    }
    
    .prompt-box {
      background: #edf2f7;
      padding: 1rem;
      border-radius: 6px;
      font-size: 0.813rem;
      color: #2d3748;
      max-height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
    }
    
    /* Field Guidance */
    .field-guidance {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 1.5rem;
    }
    
    .guidance-header {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1rem;
    }
    
    .guidance-grid {
      display: grid;
      gap: 1rem;
    }
    
    .guidance-item label {
      color: var(--text-secondary);
    }
    
    .actions {
      display: flex;
      gap: 0.625rem;
      margin-top: 1.25rem;
      padding-top: 1.25rem;
      border-top: 1px solid #e2e8f0;
    }
    
    .stage-badge {
      padding: 0.625rem 1rem;
      border-radius: 8px;
      font-weight: 500;
      font-size: 0.875rem;
      text-align: center;
      margin-bottom: 1rem;
      letter-spacing: -0.01em;
    }
    
    .stage-demo {
      background: #eff6ff;
      color: #3b82f6;
      border: 1px solid #93c5fd;
    }
    
    .stage-production {
      background: #f0fdf4;
      color: #166534;
      border: 1px solid #86efac;
    }
    
    .instruction-field {
      margin-top: 0.5rem;
    }
    
    .instruction-field label {
      font-size: 0.813rem;
      color: var(--text-secondary);
      font-weight: 500;
      letter-spacing: -0.01em;
    }
    
    .instruction-field textarea {
      font-size: 0.875rem;
      min-height: 60px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.75rem;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
    }
    
    .instruction-field textarea:hover {
      border-color: var(--border-hover);
    }
    
    .instruction-field textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .read-only-view {
      opacity: 0.85;
    }
    
    /* Production Mode - Readonly but Selectable */
    input[readonly], textarea[readonly] {
      background: var(--bg-subtle) !important;
      border-color: var(--border) !important;
      color: var(--text-primary) !important;
      cursor: text !important;
      user-select: text !important;
      -webkit-user-select: text !important;
    }
    
    input[readonly]:focus, textarea[readonly]:focus {
      outline: 1px solid var(--border-hover);
      border-color: var(--border-hover) !important;
    }
    
    select[disabled] {
      background: var(--bg-subtle) !important;
      color: var(--text-primary) !important;
      opacity: 0.8;
      cursor: not-allowed !important;
    }
    
    .save-demo-btn {
      background: var(--primary);
      color: white;
      font-size: 0.813rem;
      padding: 0.5rem 1rem;
    }
    
    .save-demo-btn:hover {
      background: var(--primary-hover);
    }
    
    /* Bottom Action Buttons */
    .bottom-actions {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      display: flex;
      gap: 0.875rem;
      z-index: 100;
    }
    
    .bottom-actions .btn {
      box-shadow: var(--shadow-lg);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
      padding: 0.75rem 1.5rem;
      font-size: 0.938rem;
    }
    
    .bottom-actions .btn:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-xl);
    }
    
    .bottom-actions .btn:active {
      transform: translateY(-1px);
    }
    
    /* Confirmation Modal */
    .confirmation-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    
    .confirmation-modal.show {
      display: flex;
    }
    
    .confirmation-content {
      background: white;
      border-radius: 8px;
      padding: 2rem;
      max-width: 500px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    
    .confirmation-content h3 {
      margin: 0 0 1rem 0;
      color: var(--text-primary);
      font-size: 1.25rem;
    }
    
    .confirmation-content p {
      margin: 0 0 1.5rem 0;
      color: #4a5568;
      line-height: 1.6;
    }
    
    .confirmation-buttons {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }
    
    /* Collapsible Instructions Section */
    /* Sleek Netflix-Style Collapsible Section */
    .instructions-toggle {
      margin: 0.75rem 0 0 0;
      padding: 0.75rem 1rem;
      background: transparent;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    
    .instructions-toggle::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 0;
      background: var(--primary);
      border-radius: 2px;
      transition: height 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .instructions-toggle:hover {
      background: var(--bg-subtle);
    }
    
    .instructions-toggle:hover::before {
      height: 60%;
    }
    
    .instructions-toggle span {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.875rem;
      letter-spacing: -0.01em;
    }
    
    .instructions-toggle .toggle-icon {
      font-size: 1rem;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--text-secondary);
      line-height: 1;
      display: flex;
      align-items: center;
    }
    
    .instructions-toggle .toggle-icon i {
      font-size: 1.125rem;
      font-weight: 600;
    }
    
    .instructions-toggle.open .toggle-icon {
      transform: rotate(180deg);
      color: var(--primary);
    }
    
    .instructions-content {
      display: none;
      margin-top: 0.5rem;
      padding: 0;
      background: transparent;
      border-radius: 8px;
      animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .instructions-content.show {
      display: block;
    }
    
    /* PDF Modal */
    .pdf-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      padding: 2rem;
    }
    
    .pdf-modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .pdf-modal-content {
      width: 90%;
      height: 90%;
      background: var(--bg-card);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-xl);
      border: 1px solid var(--border);
    }
    
    .pdf-modal-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f7fafc;
      border-radius: 8px 8px 0 0;
    }
    
    .pdf-modal-header h3 {
      margin: 0;
      font-size: 1.25rem;
      color: #2d3748;
    }
    
    .pdf-modal-close {
      background: #f87171;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.875rem;
    }
    
    .pdf-modal-close:hover {
      background: #c53030;
    }
    
    .pdf-modal-body {
      flex: 1;
      overflow: hidden;
    }
    
    .pdf-modal iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    /* Landing Page - Modern & Clean */
    .landing-page {
      min-height: 100vh;
      width: 100vw;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-subtle);
      padding: 2rem;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 9999;
    }
    
    .landing-container {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 3rem 2.5rem;
      max-width: 480px;
      width: 100%;
      box-shadow: var(--shadow-xl);
      text-align: center;
      border: 1px solid var(--border);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .landing-logo {
      font-size: 3.5rem;
      margin-bottom: 1.25rem;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,0.1));
    }
    
    .landing-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 0.625rem 0;
      letter-spacing: -0.02em;
    }
    
    .landing-subtitle {
      font-size: 0.938rem;
      color: var(--text-secondary);
      margin: 0 0 2.5rem 0;
      font-weight: 500;
    }
    
    .landing-form {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }
    
    .landing-select-group {
      text-align: left;
    }
    
    .landing-select-group label {
      display: block;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      font-size: 0.875rem;
    }
    
    .landing-select {
      width: 100%;
      padding: 0.875rem 1.125rem;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 0.938rem;
      color: var(--text-primary);
      background: var(--bg-card);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      box-shadow: var(--shadow-sm);
    }
    
    .landing-select:hover {
      border-color: var(--primary-light);
      box-shadow: var(--shadow-md);
    }
    
    .landing-select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), var(--shadow-sm);
    }
    
    .landing-start-btn {
      padding: 1rem 1.75rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 0.938rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      letter-spacing: -0.01em;
    }
    
    .landing-start-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
    }
    
    .landing-start-btn:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
    }
    
    .landing-start-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      box-shadow: var(--shadow-sm);
    }
    
    .landing-footer {
      margin-top: 1.5rem;
      font-size: 0.75rem;
      color: var(--text-muted);
    }
    
    .main-app {
      display: none;
      width: 100%;
    }
    
    .main-app.active {
      display: flex;
      width: 100%;
    }
    
    /* High-End Professional Color Palette */
    :root {
      --primary: #6366f1;
      --primary-hover: #4f46e5;
      --primary-light: #818cf8;
      --success: #10b981;
      --success-hover: #059669;
      --warning: #f59e0b;
      --danger: #ef4444;
      --bg-main: #f8fafc;
      --bg-subtle: #f1f5f9;
      --bg-card: #ffffff;
      --border: #e2e8f0;
      --border-hover: #cbd5e1;
      --text-primary: #0f172a;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --sidebar-bg: #ffffff;
      --sidebar-border: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }
    
    * {
      box-sizing: border-box;
    }
    
    body {
      font-size: 0.875rem;
      color: var(--text-primary);
      background: var(--bg-subtle);
      line-height: 1.5;
    }
    
    /* Modern Button System - High-End Feel */
    .btn {
      font-size: 0.875rem;
      font-weight: 600;
      border-radius: 8px;
      padding: 0.625rem 1.25rem;
      border: 1px solid transparent;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
      letter-spacing: -0.01em;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .btn:active {
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }
    
    .btn-primary {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
      color: white;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    
    .btn-outline-primary {
      color: var(--primary);
      border-color: var(--border);
      background: var(--bg-card);
    }
    
    .btn-outline-primary:hover {
      background: var(--bg-subtle);
      border-color: var(--primary);
      color: var(--primary-hover);
    }
    
    .btn-success {
      background: var(--success);
      border-color: var(--success);
      color: white;
    }
    
    .btn-success:hover {
      background: var(--success-hover);
      border-color: var(--success-hover);
      color: white;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }
    
    .btn-danger {
      background: var(--danger);
      border-color: var(--danger);
      color: white;
    }
    
    .btn-danger:hover {
      background: #dc2626;
      border-color: #dc2626;
      color: white;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
    }
    
    .btn-sm {
      font-size: 0.813rem;
      padding: 0.5rem 1rem;
      border-radius: 6px;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .form-control, .form-select {
      font-size: 0.875rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.625rem 0.875rem;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--bg-card);
      color: var(--text-primary);
      box-shadow: var(--shadow-sm);
    }
    
    .form-control:hover, .form-select:hover {
      border-color: var(--border-hover);
    }
    
    .form-control:focus, .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), var(--shadow-sm);
      outline: none;
    }
    
    .form-control-sm, .form-select-sm {
      font-size: 0.813rem;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
    }
    
    .form-label {
      font-size: 0.813rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      letter-spacing: -0.01em;
    }
    
    .card {
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: none;
      background: var(--bg-card);
    }
    
    /* Custom button toggle for sidebar */
    .btn-toggle-active {
      background: var(--primary) !important;
      color: white !important;
      border-color: var(--primary) !important;
    }
    
    .btn-toggle-inactive {
      background: white !important;
      color: var(--text-secondary) !important;
      border-color: var(--border) !important;
    }
    
    .btn-toggle-inactive:hover {
      background: var(--bg-subtle) !important;
      color: var(--text-primary) !important;
    }
    
    /* Consistency toggle buttons */
    .consistency-toggle-btn {
      background: white;
      color: var(--text-secondary);
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    
    .consistency-toggle-btn:hover {
      background: var(--bg-subtle);
      color: var(--text-primary);
      border-color: var(--primary);
    }
    
    .consistency-toggle-btn.consistency-active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .accordion-item {
      border: 1px solid var(--border);
      border-radius: 8px !important;
      overflow: hidden;
      margin-bottom: 0.75rem;
    }
    
    .accordion-button {
      font-size: 0.875rem;
      font-weight: 600;
      padding: 1rem 1.25rem;
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
      border-radius: 8px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
    }
    
    .accordion-button:hover {
      background: var(--bg-subtle);
      border-color: var(--border-hover);
    }
    
    .accordion-button:not(.collapsed) {
      background: var(--bg-subtle);
      color: var(--text-primary);
      box-shadow: none;
      border-bottom-left-radius: 0;
      border-bottom-right-radius: 0;
    }
    
    .accordion-button:focus {
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      border-color: var(--primary);
      outline: none;
    }
    
    .accordion-body {
      padding: 1.25rem;
      font-size: 0.875rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-top: none;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    
    .badge {
      font-size: 0.75rem;
      padding: 0.375rem 0.625rem;
      font-weight: 500;
      border-radius: 6px;
      letter-spacing: -0.01em;
    }
    
    /* Clean Sidebar - Light Theme like Tabs */
    .sidebar {
      background: var(--sidebar-bg);
      border-right: 1px solid var(--border);
      font-size: 0.75rem;
    }
    
    .sidebar h2 {
      color: var(--text-primary);
      font-size: 1.125rem;
      font-weight: 700;
    }
    
    .sidebar-subtitle {
      color: var(--text-muted);
      font-size: 0.75rem;
    }
    
    .sidebar-section {
      margin-bottom: 1.25rem;
    }
    
    .sidebar-section label {
      font-size: 0.813rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      letter-spacing: -0.01em;
    }
    
    .sidebar input, .sidebar select {
      font-size: 0.875rem;
      padding: 0.625rem 0.875rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 8px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-sm);
    }
    
    .sidebar input:hover, .sidebar select:hover {
      border-color: var(--border-hover);
      box-shadow: var(--shadow-md);
    }
    
    .sidebar input:focus, .sidebar select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      outline: none;
    }
    
    /* Merchant Dropdown - Premium Netflix Style */
    .merchant-dropdown {
      background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-subtle) 100%) !important;
      border: 1px solid var(--primary) !important;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.15) !important;
      font-weight: 600 !important;
      color: var(--text-primary) !important;
    }
    
    .merchant-dropdown:hover {
      border-color: var(--primary-hover) !important;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25) !important;
    }
    
    .merchant-dropdown:focus {
      border-color: var(--primary) !important;
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15), 0 4px 12px rgba(99, 102, 241, 0.2) !important;
    }
    
    .sidebar-divider {
      background: var(--border);
      height: 1px;
      margin: 1.25rem 0;
    }
    
    /* Compact Main Content */
    .main-content {
      background: var(--bg-main);
      padding: 2rem;
      flex: 1;
      width: 100%;
    }
    
    .container {
      max-width: none;
      width: 100%;
      margin: 0;
      padding: 0 1rem;
    }
    
    #results {
      width: 100%;
    }
    
    h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
    
    .subtitle {
      color: var(--text-secondary);
      font-size: 0.875rem;
    }
    
    /* Professional Guidance Grid - Compact */
    .guidance-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.875rem;
    }
    
    @media (max-width: 1200px) {
      .guidance-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (max-width: 768px) {
      .guidance-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .guidance-item {
      display: flex;
      flex-direction: column;
    }
    
    .guidance-item label {
      font-size: 0.813rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      letter-spacing: -0.01em;
    }
    
    .guidance-item textarea, .guidance-item input, .guidance-item select {
      font-size: 0.875rem;
      padding: 0.625rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--bg-card);
      color: var(--text-primary);
      resize: vertical;
      min-height: 70px;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .guidance-item textarea:focus, 
    .guidance-item input:focus,
    .guidance-item select:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Clean Alert Messages */
    .alert {
      font-size: 0.813rem;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      border: 1px solid;
    }
    
    .alert-success {
      background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
      border: 1px solid #86efac;
      color: #166534;
      border-radius: 10px;
      padding: 1rem 1.25rem;
      box-shadow: var(--shadow-sm);
      font-weight: 500;
    }
    
    .alert-info {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      border: 1px solid #93c5fd;
      color: #1e40af;
      border-radius: 10px;
      padding: 1rem 1.25rem;
      box-shadow: var(--shadow-sm);
      font-weight: 500;
    }
    
    .alert-error {
      background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
      border: 1px solid #fca5a5;
      color: #991b1b;
      border-radius: 10px;
      padding: 1rem 1.25rem;
      box-shadow: var(--shadow-sm);
      font-weight: 500;
    }
    
    /* Schedule Items - Clean Cards */
    .schedule-item {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 1rem;
      box-shadow: var(--shadow-sm);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .schedule-item:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--border-hover);
    }
    
    .schedule-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      background: var(--bg-subtle);
    }
    
    .schedule-content {
      padding: 1rem;
      background: var(--bg-card);
    }
  </style>
</head>
<body>
  <!-- Landing Page -->
  <div class="landing-page" id="landingPage">
    <div class="landing-container">
      <div class="landing-logo">🚗</div>
      <h1 class="landing-title">Garage Contract Processor</h1>
      <p class="landing-subtitle">Extract revenue schedules from contracts with AI precision</p>
      
      <div class="landing-form">
        <div class="landing-select-group">
          <label for="landingMerchantSelect">Select Merchant</label>
          <select id="landingMerchantSelect" class="landing-select" required>
            <option value="">Loading merchants...</option>
          </select>
            </div>
        
        <div id="landingNewMerchantContainer" style="display:none;">
          <label style="display:block;font-weight:600;color:#4a5568;margin-bottom:0.5rem;text-align:left;">New Merchant Name</label>
          <input type="text" id="landingNewMerchantName" placeholder="Enter merchant name" style="width:100%;padding:0.875rem 1rem;border:2px solid #e2e8f0;border-radius:8px;font-size:1rem;">
            </div>
        
        <button type="button" class="landing-start-btn" onclick="startProcessing()">
          Start Processing →
        </button>
          </div>

      <div class="landing-footer">
        Powered by Tabs Platform · Garage
            </div>
    </div>
  </div>

  <!-- Main App (Hidden Initially) -->
  <div class="main-app" id="mainApp">
  
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-brand" onclick="goToLanding()">
        <span class="brand-icon">🚗</span>
        <span class="brand-text">Garage</span>
      </div>
      <button type="button" class="sidebar-collapse-btn" onclick="toggleSidebar()">
        <i class="bi bi-chevron-left" id="collapseIcon"></i>
      </button>
    </div>
    
    <form id="uploadForm">
      <!-- Merchant Dropdown - Sleek Netflix Style -->
      <div class="sidebar-section">
        <label>Merchant</label>
        <select id="merchantSelect" class="merchant-dropdown" onchange="handleMerchantChange()">
          <option value="">Select merchant...</option>
        </select>
      </div>
      
      <div class="sidebar-divider"></div>
      
      <div class="sidebar-section">
              <label>Model</label>
              <select id="model">
                <option value="gpt-5" selected>GPT-5</option>
                <option value="gpt-5-thinking">GPT-5 Thinking</option>
                <option value="o3">o3</option>
              </select>
            </div>
      
      <!-- Consistency Toggle -->
      <div class="sidebar-section">
        <label>Training Data Consistency</label>
        <input type="hidden" id="consistencyValue" value="consistent">
        <div style="display:flex;gap:0.5rem;">
          <button type="button" class="consistency-toggle-btn consistency-active" data-value="consistent" onclick="setConsistency('consistent')">
            Consistent
          </button>
          <button type="button" class="consistency-toggle-btn" data-value="non-consistent" onclick="setConsistency('non-consistent')">
            Non-consistent
          </button>
        </div>
      </div>
      
      <div class="sidebar-section">
        <label>Agreement Runs</label>
              <select id="runs">
                <option value="1" selected>1</option>
                <option value="2">2</option>
                <option value="3">3</option>
              </select>
            </div>
      
      <div class="sidebar-section">
        <label>Multi-Schedule Detection</label>
              <select id="forceMulti">
                <option value="auto" selected>Auto (AI decides)</option>
                <option value="on">Force ON (always look for multiple)</option>
                <option value="off">Force OFF (single schedule only)</option>
              </select>
              <div style="font-size:0.75rem;color:#a0aec0;margin-top:0.5rem;">
                Controls whether AI searches for multiple revenue schedules
              </div>
            </div>
      
      <div class="sidebar-divider"></div>
      
      <div class="sidebar-section">
        <label>Integration Mapping</label>
        <input type="file" id="integrationFile" accept=".xlsx,.csv" style="font-size:0.75rem;padding:0.5rem;">
          </div>

      <!-- Consistency Toggle (Production Mode Only) -->
      <!-- Contract Upload / Tabs Toggle -->
      <div class="sidebar-section">
        <label>Contract Source *</label>
        <div class="btn-group w-100 mb-2" role="group">
          <button type="button" id="uploadToggle" class="btn btn-sm btn-toggle-active" onclick="showUploadMode()"><i class="bi bi-file-pdf me-1"></i>Upload PDF</button>
          <button type="button" id="tabsToggle" class="btn btn-sm btn-toggle-inactive" onclick="showTabsMode()"><i class="bi bi-link-45deg me-1"></i>From Tabs</button>
        </div>
        
        <!-- Upload Mode -->
        <div id="uploadMode">
          <input type="file" id="file" accept="application/pdf" required style="font-size:0.75rem;padding:0.5rem;">
        </div>
        
        <!-- Tabs Mode -->
        <div id="tabsMode" style="display:none;">
          <input type="text" id="tabsContractId" placeholder="Enter Contract ID" class="form-control">
          <div id="tabsStatus" style="font-size:0.813rem;color:var(--text-secondary);margin-top:0.5rem;"></div>
        </div>
      </div>
      
      <button type="submit" class="btn btn-primary" id="submitBtn" style="width:100%;margin-top:1rem;">Analyze Contract</button>
      <div class="alert" id="status" style="margin-top:0.75rem;"></div>
        </form>
        
        <!-- Settings Button (Demo & Configs) -->
        <div style="padding:1.25rem;border-top:1px solid var(--border);">
          <button type="button" class="btn btn-outline-secondary" onclick="openDemoConfigsModal()" style="width:100%;display:flex;align-items:center;justify-content:center;gap:0.5rem;">
            <i class="bi bi-gear"></i>
            <span>Demo & Configs</span>
          </button>
        </div>
    </div>

  <!-- Main Content -->
  <div class="main-content">
    <div class="container">
    <div id="results"></div>

    <div id="guidanceSection" style="display:none;">
      <div class="accordion mb-3">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#guidanceCollapse">
              <span>Field-Specific Guidance for <strong id="merchantName"></strong></span>
            </button>
          </h2>
          <div id="guidanceCollapse" class="accordion-collapse collapse">
            <div class="accordion-body">
              <p style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 1rem;">
                Add instructions for how to extract specific fields from this merchant's contracts. These rules will apply to ALL future contracts.
              </p>
              
              <div class="guidance-grid">
        <div class="guidance-item">
          <label>Item Name Extraction</label>
          <textarea id="guid_item_name" placeholder="e.g., Always use the exact wording from the 'Service Description' section"></textarea>
        </div>
        <div class="guidance-item">
          <label>Description Extraction</label>
          <textarea id="guid_description" placeholder="e.g., Include community/location name, or contract-specific details"></textarea>
        </div>
        <div class="guidance-item">
          <label>Total Price Extraction</label>
          <textarea id="guid_total_price" placeholder="e.g., Use the 'Total Amount' column, not 'Monthly Amount'"></textarea>
        </div>
        <div class="guidance-item">
          <label>Billing Type Determination</label>
          <textarea id="guid_billing_type" placeholder="e.g., All items are Flat price unless explicitly stated 'per user'"></textarea>
        </div>
        <div class="guidance-item">
          <label>Quantity Rules</label>
          <textarea id="guid_quantity" placeholder="e.g., Default to 1 unless 'Number of Users' is specified"></textarea>
        </div>
        <div class="guidance-item">
          <label>Start Date Extraction</label>
          <textarea id="guid_start_date" placeholder="e.g., Use 'Effective Date' field, format as YYYY-MM-DD"></textarea>
        </div>
        <div class="guidance-item">
          <label>Frequency/Billing Period</label>
          <textarea id="guid_frequency_unit" placeholder="e.g., Platform fees are always monthly, Setup fees are always one-time"></textarea>
        </div>
        <div class="guidance-item">
          <label>Periods Calculation</label>
          <textarea id="guid_periods" placeholder="e.g., Number of billing cycles = months ÷ frequency"></textarea>
        </div>
        <div class="guidance-item">
          <label>Months of Service / Term</label>
          <textarea id="guid_months_of_service" placeholder="e.g., Look for Initial Term or Contract Duration (12, 24, 36 months)"></textarea>
        </div>
        <div class="guidance-item">
          <label>Net Terms / Payment Terms</label>
          <textarea id="guid_net_terms" placeholder="e.g., Typically Net 30, look for 'payment due within X days'"></textarea>
        </div>
        <div class="guidance-item">
          <label>Billing Timing / Arrears</label>
          <textarea id="guid_billing_timing" placeholder="e.g., Usually billed in advance (first), or in arrears (last)"></textarea>
        </div>
        <div class="guidance-item">
          <label>Event to Track</label>
          <textarea id="guid_event_to_track" placeholder="e.g., For usage-based billing only, usually {item_name} + ' overage'"></textarea>
        </div>
        <div class="guidance-item">
          <label>General Guidance</label>
          <textarea id="guid_general" placeholder="e.g., This merchant always has 3 line items: Platform Fee, Setup Fee, and Training"></textarea>
        </div>
      </div>
      
      <!-- Advanced Options Accordion -->
      <div class="accordion mt-3" id="advancedOptionsAccordion">
        
        <!-- Default Overrides Section -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#defaultOverridesCollapse">
              <i class="bi bi-gear me-2 text-primary"></i>
              <span>Default Value Overrides</span>
              <span class="badge bg-light text-secondary ms-2">Optional</span>
            </button>
          </h2>
          <div id="defaultOverridesCollapse" class="accordion-collapse collapse">
            <div class="accordion-body">
              <p class="text-muted mb-3" style="font-size: 0.75rem;">
                <i class="bi bi-info-circle me-1"></i>
                Set specific values that will ALWAYS override what the AI extracts. Leave blank to use AI extraction.
              </p>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label small fw-semibold text-secondary">Override Net Terms (days)</label>
                  <input type="number" class="form-control form-control-sm" id="default_net_terms" placeholder="e.g., 30">
                </div>
                <div class="col-md-6">
                  <label class="form-label small fw-semibold text-secondary">Override Revenue Category</label>
                  <input type="text" class="form-control form-control-sm" id="default_revenue_category" placeholder="e.g., SaaS Subscription">
                </div>
                <div class="col-md-6">
                  <label class="form-label small fw-semibold text-secondary">Override Billing Timing</label>
                  <select class="form-select form-select-sm" id="default_billing_timing">
                    <option value="">Use AI extraction</option>
                    <option value="first">Bill first of period</option>
                    <option value="last">Bill last of period</option>
                    <option value="next_period">Bill first of next period</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label small fw-semibold text-secondary">Override Arrears</label>
                  <select class="form-select form-select-sm" id="default_arrears">
                    <option value="">Use AI extraction</option>
                    <option value="false">No (advance payment)</option>
                    <option value="true">Yes (in arrears)</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Field Exclusions Section -->
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#exclusionsCollapse">
              <i class="bi bi-x-circle me-2 text-danger"></i>
              <span>Field Exclusions</span>
              <span class="badge bg-light text-secondary ms-2">Optional</span>
            </button>
          </h2>
          <div id="exclusionsCollapse" class="accordion-collapse collapse">
            <div class="accordion-body">
              <p class="text-muted mb-3" style="font-size: 0.75rem;">
                <i class="bi bi-info-circle me-1"></i>
                Select fields to EXCLUDE from the API response. Excluded fields won't appear in garage_revenue_schedules.
              </p>
              <div class="row g-2">
                <div class="col-md-6 col-lg-4">
                  <div class="form-check form-switch">
                    <input class="form-check-input exclude-field" type="checkbox" value="item_description" id="exclude_item_description">
                    <label class="form-check-label small" for="exclude_item_description">item_description</label>
                  </div>
                </div>
                <div class="col-md-6 col-lg-4">
                  <div class="form-check form-switch">
                    <input class="form-check-input exclude-field" type="checkbox" value="revenue_category" id="exclude_revenue_category">
                    <label class="form-check-label small" for="exclude_revenue_category">revenue_category</label>
                  </div>
                </div>
                <div class="col-md-6 col-lg-4">
                  <div class="form-check form-switch">
                    <input class="form-check-input exclude-field" type="checkbox" value="service_start_date" id="exclude_service_start_date">
                    <label class="form-check-label small" for="exclude_service_start_date">service_start_date</label>
                  </div>
                </div>
                <div class="col-md-6 col-lg-4">
                  <div class="form-check form-switch">
                    <input class="form-check-input exclude-field" type="checkbox" value="service_term" id="exclude_service_term">
                    <label class="form-check-label small" for="exclude_service_term">service_term</label>
                  </div>
                </div>
                <div class="col-md-6 col-lg-4">
                  <div class="form-check form-switch">
                    <input class="form-check-input exclude-field" type="checkbox" value="event_to_track" id="exclude_event_to_track">
                    <label class="form-check-label small" for="exclude_event_to_track">event_to_track</label>
                  </div>
                </div>
                <div class="col-md-6 col-lg-4">
                  <div class="form-check form-switch">
                    <input class="form-check-input exclude-field" type="checkbox" value="integration_item" id="exclude_integration_item">
                    <label class="form-check-label small" for="exclude_integration_item">integration_item</label>
                  </div>
                </div>
                <div class="col-md-6 col-lg-4">
                  <div class="form-check form-switch">
                    <input class="form-check-input exclude-field" type="checkbox" value="discounts" id="exclude_discounts">
                    <label class="form-check-label small" for="exclude_discounts">discounts</label>
                  </div>
                </div>
                <div class="col-md-6 col-lg-4">
                  <div class="form-check form-switch">
                    <input class="form-check-input exclude-field" type="checkbox" value="pricing_tiers" id="exclude_pricing_tiers">
                    <label class="form-check-label small" for="exclude_pricing_tiers">pricing_tiers</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
              </div>

              <!-- MIS Upload Section (Demo Mode Only) -->
              <div id="misUploadContainer" style="display:none;margin-top:1.5rem;padding:1rem;background:#f0f4ff;border:1px solid #c7d2fe;border-radius:8px;">
                <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem;">
                  <div>
                    <div style="font-weight:600;color:#4338ca;font-size:0.875rem;">Upload MIS Document (Optional)</div>
                    <div style="font-size:0.75rem;color:var(--text-secondary);">Auto-populate guidance fields using AI extraction</div>
                  </div>
                </div>
                <input type="file" id="misFile" accept=".pdf,.doc,.docx,.txt" class="form-control form-control-sm mb-2">
                <button type="button" class="btn btn-primary btn-sm w-100" onclick="uploadMIS()">
                  <i class="bi bi-robot me-1"></i> Extract Instructions from MIS
                </button>
                <div id="misStatus" style="margin-top:0.75rem;font-size:0.75rem;color:var(--text-secondary);text-align:center;"></div>
              </div>

              <div style="margin-top: 1.5rem; display: flex; gap: 0.625rem;">
                <button type="button" class="btn btn-success btn-sm" onclick="saveFieldGuidance()">
                  <i class="bi bi-save me-1"></i> Save All Guidance
                </button>
                <button type="button" class="btn btn-secondary btn-sm" onclick="loadFieldGuidance()">
                  <i class="bi bi-arrow-clockwise me-1"></i> Reload
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </div> <!-- End of main-app -->
  
  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="confirmation-modal">
    <div class="confirmation-content">
      <h3>Confirm Save</h3>
      <p>This training session will be used as reference material for future contract processing.</p>
      <p><strong>Important:</strong> If this data is incorrect or filled incorrectly, the AI model might hallucinate or make similar mistakes on future contracts. Please double-check all fields before saving.</p>
      <div class="confirmation-buttons">
        <button class="btn" style="background:#718096;color:white;" onclick="closeConfirmation()">Cancel</button>
        <button class="btn btn-success" onclick="confirmSave()">
          <i class="bi bi-check-circle me-1"></i> Confirm & Save
        </button>
      </div>
    </div>
  </div>
  
  <!-- PDF Modal -->
  <div id="pdfModal" class="pdf-modal" onclick="closePDFModal(event)">
    <div class="pdf-modal-content" onclick="event.stopPropagation()">
      <div class="pdf-modal-header">
        <h3>Contract PDF</h3>
        <button class="pdf-modal-close" onclick="closePDFModal()">✕ Close</button>
      </div>
      <div class="pdf-modal-body">
        <iframe id="pdfViewer" src=""></iframe>
      </div>
    </div>
  </div>
  
  <!-- Garage Output JSON Modal -->
  <div id="garageOutputModal" class="pdf-modal" onclick="closeGarageOutputModal(event)">
    <div class="pdf-modal-content" onclick="event.stopPropagation()" style="max-width:800px;height:auto;max-height:80vh;">
      <div class="pdf-modal-header">
        <h3>Garage Revenue Schedules JSON</h3>
        <button class="pdf-modal-close" onclick="closeGarageOutputModal()">✕ Close</button>
      </div>
      <div class="pdf-modal-body" style="padding:1.5rem;overflow-y:auto;">
        <pre id="garageOutputJSON" style="background:#1e293b;color:#e2e8f0;padding:1.5rem;border-radius:8px;font-size:0.813rem;line-height:1.6;overflow-x:auto;"></pre>
      </div>
    </div>
  </div>
  
  <!-- Demo & Configs Auth Modal -->
  <div id="demoAuthModal" class="pdf-modal" onclick="closeDemoAuthModal(event)">
    <div class="pdf-modal-content" onclick="event.stopPropagation()" style="max-width:500px;height:auto;">
      <div class="pdf-modal-header">
        <h3>Demo & Configs Access</h3>
        <button class="pdf-modal-close" onclick="closeDemoAuthModal()">✕ Close</button>
      </div>
      <div class="pdf-modal-body" style="padding:2rem;">
        <p style="color:var(--text-secondary);margin-bottom:1.5rem;font-size:0.875rem;">
          Enter your Tabs API key to access training and configuration settings.
        </p>
        
        <form onsubmit="authenticateDemoAccess(event)">
          <div style="margin-bottom:1.5rem;">
            <label style="display:block;font-weight:600;margin-bottom:0.5rem;color:var(--text-primary);font-size:0.875rem;">Tabs API Key</label>
            <input type="password" id="demoApiKey" class="form-control" placeholder="Enter your Tabs API key" required style="width:100%;padding:0.75rem;border:1px solid var(--border);border-radius:8px;font-size:0.875rem;">
          </div>
          
          <div id="demoAuthError" style="display:none;background:linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);color:#991b1b;padding:0.75rem 1rem;border-radius:8px;margin-bottom:1rem;font-size:0.813rem;border:1px solid #f87171;"></div>
          
          <button type="submit" class="btn btn-primary w-100" style="padding:0.75rem;font-size:0.875rem;">
            <i class="bi bi-unlock me-2"></i> Access Demo & Configs
          </button>
        </form>
      </div>
    </div>
  </div>

  <script>
    let integrationMapping = [];
    let currentData = null;
    let currentMerchantId = 'default';
    let currentStage = 'production';  // Always production mode on main page
    let allMerchants = [];

    const form = document.getElementById('uploadForm');
    const status = document.getElementById('status');
    
    // Landing page merchant selection
    const landingMerchantSelect = document.getElementById('landingMerchantSelect');
    const landingNewMerchantContainer = document.getElementById('landingNewMerchantContainer');
    
    // Start Processing - Transition from landing to main app
    function startProcessing() {
      const selectedMerchant = landingMerchantSelect.value;
      
      if (selectedMerchant === '__new__') {
        const newMerchantName = document.getElementById('landingNewMerchantName').value.trim();
        if (!newMerchantName) {
          alert('Please enter a merchant name');
          return;
        }
        currentMerchantId = newMerchantName.replace(/[^a-zA-Z0-9_-]/g, '_');
      } else if (selectedMerchant) {
        currentMerchantId = selectedMerchant;
      } else {
        alert('Please select a merchant');
        return;
      }
      
      // Hide landing page, show main app
      document.getElementById('landingPage').style.display = 'none';
      document.getElementById('mainApp').classList.add('active');
      
      // Populate merchant dropdown in sidebar
      populateSidebarMerchantDropdown();
      
      // Set the selected merchant in the dropdown
      document.getElementById('merchantSelect').value = currentMerchantId;
      
      // Initialize the stage
      handleStageChange();
    }
    
    // Toggle sidebar collapse
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('collapsed');
    }
    
    // Go to landing page - click on Garage brand
    function goToLanding() {
      // Clear results
      document.getElementById('results').innerHTML = '';
      
      // Remove bottom actions if present
      const bottomActions = document.querySelector('.bottom-actions');
      if (bottomActions) {
        bottomActions.remove();
      }
      
      // Reset merchant selection
      currentMerchantId = null;
      
      // Show landing page, hide main app
      document.getElementById('landingPage').style.display = 'flex';
      document.getElementById('mainApp').classList.remove('active');
      
      // Reset landing page form
      landingMerchantSelect.value = '';
      landingNewMerchantContainer.style.display = 'none';
      document.getElementById('landingNewMerchantName').value = '';
    }
    
    // Handle merchant change from dropdown
    function handleMerchantChange() {
      const merchantSelect = document.getElementById('merchantSelect');
      const newMerchantId = merchantSelect.value;
      
      if (!newMerchantId || newMerchantId === currentMerchantId) {
        return;
      }
      
      // Clear results
      document.getElementById('results').innerHTML = '';
      
      // Remove bottom actions if present
      const bottomActions = document.querySelector('.bottom-actions');
      if (bottomActions) {
        bottomActions.remove();
      }
      
      // Update current merchant
      currentMerchantId = newMerchantId;
      
      // Reload guidance for new merchant
      handleStageChange();
    }
    
    // Handle landing page merchant selection
    landingMerchantSelect.addEventListener('change', () => {
      if (landingMerchantSelect.value === '__new__') {
        landingNewMerchantContainer.style.display = 'block';
      } else {
        landingNewMerchantContainer.style.display = 'none';
      }
    });
    const results = document.getElementById('results');
    const submitBtn = document.getElementById('submitBtn');
    
    async function loadMerchants() {
      try {
        const res = await fetch('/api/list-merchants');
        const data = await res.json();
        allMerchants = data.merchants || [];
        
        // Populate landing page dropdown
        populateLandingMerchants();
      } catch (error) {
        console.error('Failed to load merchants:', error);
        allMerchants = [];
        populateLandingMerchants();
      }
    }
    
    function populateLandingMerchants() {
      landingMerchantSelect.innerHTML = '<option value="">-- Select a Merchant --</option>';
      
      // Add all merchants (show all in landing, we'll filter in main app based on stage)
      allMerchants.forEach(merchant => {
        const option = document.createElement('option');
        option.value = merchant.id;
        option.textContent = merchant.name;
        landingMerchantSelect.appendChild(option);
      });
      
      // Always add "Create New Merchant" option on landing page
      const newOption = document.createElement('option');
      newOption.value = '__new__';
      newOption.textContent = '+ Create New Merchant';
      landingMerchantSelect.appendChild(newOption);
    }
    
    // Populate sidebar merchant dropdown
    function populateSidebarMerchantDropdown() {
      const merchantSelect = document.getElementById('merchantSelect');
      merchantSelect.innerHTML = '<option value="">Select merchant...</option>';
      
      allMerchants.forEach(merchant => {
        const option = document.createElement('option');
        option.value = merchant.id;
        option.textContent = `🏢 ${merchant.name}`;
        merchantSelect.appendChild(option);
      });
    }
    
    function setConsistency(value) {
      document.getElementById('consistencyValue').value = value;
      document.querySelectorAll('.consistency-toggle-btn').forEach(btn => {
        btn.classList.remove('consistency-active');
      });
      document.querySelector(`.consistency-toggle-btn[data-value="${value}"]`).classList.add('consistency-active');
    }
    
    function handleStageChange() {
      // Always production mode - no stage switching
      currentStage = 'production';
      
      // Add production mode badge
      const badge = document.createElement('div');
      badge.className = 'stage-badge stage-production';
      badge.textContent = 'PRODUCTION MODE: Live extraction with trained AI';
      
      const existing = document.querySelector('.stage-badge');
      if (existing) existing.remove();
      
      form.insertBefore(badge, form.firstChild);
      
      // Clear results
      document.getElementById('results').innerHTML = '';
      currentData = null;
      
      // Hide bottom action buttons
      const bottomActions = document.querySelector('.bottom-actions');
      if (bottomActions) {
        bottomActions.remove();
      }
      
      // Always hide guidance section in production
      const guidanceSection = document.getElementById('guidanceSection');
      if (guidanceSection) {
        guidanceSection.style.display = 'none';
      }
    }

    // Load Previous Training Session (Demo Mode)
    async function loadPreviousTraining() {
      if (currentStage !== 'demo') {
        showStatus('error', '❌ Can only load training in Demo mode');
        return;
      }
      
      if (!currentMerchantId) {
        showStatus('error', '❌ No merchant selected');
        return;
      }
      
      showStatus('info', '⏳ Loading previous training session...');
      
      try {
        // Load demo session
        const demoRes = await fetch(`/api/load-demo-session?merchantId=${encodeURIComponent(currentMerchantId)}`);
        const demoData = await demoRes.json();
        
        if (!demoData.success || !demoData.demoSession) {
          showStatus('error', `❌ No training session found for ${currentMerchantId}`);
          return;
        }
        
        // Set currentData to the loaded session
        currentData = {
          schedules: demoData.demoSession.schedules,
          system_prompt: demoData.demoSession.system_prompt_used,
          garage_revenue_schedules: demoData.demoSession.garage_revenue_schedules,
          pdf_session_id: demoData.demoSession.pdf_session_id,
          model_used: 'loaded-from-training'
        };
        
        // Render the results (will show editable fields in demo mode)
        renderResults(currentData);
        
        // Show guidance section
        document.getElementById('guidanceSection').style.display = 'block';
        document.getElementById('merchantName').textContent = currentMerchantId;
        document.getElementById('misUploadContainer').style.display = 'block';
        
        // Load merchant guidance
        await loadFieldGuidance();
        
        showStatus('success', `✅ Loaded training session with ${currentData.schedules.length} schedule(s)`);
        
        // Scroll to results
        document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        
      } catch (error) {
        console.error('Load training error:', error);
        showStatus('error', '❌ Failed to load training: ' + error.message);
      }
    }

    // Upload MIS and extract instructions
    async function uploadMIS() {
      const fileInput = document.getElementById('misFile');
      const file = fileInput.files[0];
      
      if (!file) {
        showStatus('error', '❌ Please select a MIS document first');
        return;
      }
      
      // Use the merchant selected on landing page
      const merchantId = currentMerchantId;
      
      if (!merchantId) {
        showStatus('error', '❌ Merchant not selected');
        return;
      }
      
      const misStatus = document.getElementById('misStatus');
      misStatus.textContent = '⏳ Extracting instructions from MIS...';
      misStatus.style.color = 'var(--text-secondary)';
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('merchantId', merchantId);
      
      try {
        const res = await fetch('/api/extract-mis-instructions', {
          method: 'POST',
          body: formData
        });
        
        const data = await res.json();
        
        if (!res.ok) throw new Error(data.error || 'Failed to extract instructions');
        
        // Populate the general guidance field
        const generalGuidanceField = document.getElementById('guid_general');
        if (generalGuidanceField && data.instructions) {
          generalGuidanceField.value = data.instructions;
          misStatus.textContent = '✅ Instructions extracted and populated in General Guidance!';
          misStatus.style.color = '#38a169';
          showStatus('success', `✅ MIS instructions extracted (${data.instructions.length} characters) - Check General Guidance field`);
        } else {
          misStatus.textContent = '⚠️ No instructions found in MIS';
          misStatus.style.color = '#d69e2e';
        }
      } catch (error) {
        console.error('MIS upload error:', error);
        misStatus.textContent = 'Failed to extract instructions';
        misStatus.style.color = '#f87171';
        showStatus('error', '❌ Failed to extract MIS instructions: ' + error.message);
      }
    }

    document.getElementById('integrationFile').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 }).filter(r => r.length);
        
        if (rows.length >= 2) {
          integrationMapping = rows.slice(1).map(r => [String(r[0]||'').trim(), String(r[1]||'').trim()]).filter(p => p[0] && p[1]);
          showStatus('info', `✓ ${integrationMapping.length} mappings loaded`);
        }
      };
      reader.readAsArrayBuffer(file);
    });

    async function loadFieldGuidance() {
      if (!currentMerchantId) return;
      const merchantId = currentMerchantId;
      
      try {
        const res = await fetch(`/api/load-guidance?merchantId=${encodeURIComponent(merchantId)}`);
        const data = await res.json();
        
        if (data.guidance && data.guidance.field_specific) {
          const fs = data.guidance.field_specific;
          document.getElementById('guid_item_name').value = fs.item_name || '';
          document.getElementById('guid_description').value = fs.description || '';
          document.getElementById('guid_total_price').value = fs.total_price || '';
          document.getElementById('guid_billing_type').value = fs.billing_type || '';
          document.getElementById('guid_quantity').value = fs.quantity || '';
          document.getElementById('guid_start_date').value = fs.start_date || '';
          document.getElementById('guid_frequency_unit').value = fs.frequency_unit || '';
          document.getElementById('guid_periods').value = fs.periods || '';
          document.getElementById('guid_months_of_service').value = fs.months_of_service || '';
          document.getElementById('guid_net_terms').value = fs.net_terms || '';
          document.getElementById('guid_billing_timing').value = fs.billing_timing || '';
          document.getElementById('guid_event_to_track').value = fs.event_to_track || '';
          document.getElementById('guid_general').value = fs.general || '';
        }
        
        // Load default overrides
        if (data.guidance && data.guidance.default_overrides) {
          const defaults = data.guidance.default_overrides;
          document.getElementById('default_net_terms').value = defaults.net_terms || '';
          document.getElementById('default_revenue_category').value = defaults.revenue_category || '';
          document.getElementById('default_billing_timing').value = defaults.billing_timing || '';
          document.getElementById('default_arrears').value = defaults.arrears !== undefined ? String(defaults.arrears) : '';
        }
        
        // Load excluded fields
        if (data.guidance && data.guidance.excluded_fields) {
          document.querySelectorAll('.exclude-field').forEach(cb => {
            cb.checked = data.guidance.excluded_fields.includes(cb.value);
          });
        }
      } catch (error) {
        console.error('Failed to load guidance:', error);
      }
    }

    async function saveFieldGuidance() {
      // Build default overrides object
      const default_overrides = {};
      const netTerms = document.getElementById('default_net_terms').value;
      const revenueCategory = document.getElementById('default_revenue_category').value.trim();
      const billingTiming = document.getElementById('default_billing_timing').value;
      const arrears = document.getElementById('default_arrears').value;
      
      if (netTerms) default_overrides.net_terms = parseInt(netTerms);
      if (revenueCategory) default_overrides.revenue_category = revenueCategory;
      if (billingTiming) default_overrides.billing_timing = billingTiming;
      if (arrears) default_overrides.arrears = arrears === 'true';
      
      // Build excluded fields array
      const excluded_fields = Array.from(document.querySelectorAll('.exclude-field:checked'))
        .map(cb => cb.value);
      
      const guidance = {
        field_specific: {
          item_name: document.getElementById('guid_item_name').value.trim(),
          description: document.getElementById('guid_description').value.trim(),
          total_price: document.getElementById('guid_total_price').value.trim(),
          billing_type: document.getElementById('guid_billing_type').value.trim(),
          quantity: document.getElementById('guid_quantity').value.trim(),
          start_date: document.getElementById('guid_start_date').value.trim(),
          frequency_unit: document.getElementById('guid_frequency_unit').value.trim(),
          periods: document.getElementById('guid_periods').value.trim(),
          months_of_service: document.getElementById('guid_months_of_service').value.trim(),
          net_terms: document.getElementById('guid_net_terms').value.trim(),
          billing_timing: document.getElementById('guid_billing_timing').value.trim(),
          event_to_track: document.getElementById('guid_event_to_track').value.trim(),
          general: document.getElementById('guid_general').value.trim()
        },
        default_overrides,
        excluded_fields,
        system_additions: '',
        updated_at: new Date().toISOString()
      };

      try {
        const res = await fetch('/api/save-guidance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ merchantId: currentMerchantId, guidance })
        });

        if (res.ok) {
          showStatus('success', `✅ Field-specific guidance saved for ${currentMerchantId}`);
        } else {
          throw new Error('Save failed');
        }
      } catch (error) {
        showStatus('error', '❌ Failed to save: ' + error.message);
      }
    }

    // Bootstrap handles accordion toggling automatically - no custom function needed

    // Toggle functions - Custom button styling for visibility
    function showUploadMode() {
      document.getElementById('uploadMode').style.display = 'block';
      document.getElementById('tabsMode').style.display = 'none';
      
      const uploadBtn = document.getElementById('uploadToggle');
      const tabsBtn = document.getElementById('tabsToggle');
      
      uploadBtn.className = 'btn btn-sm btn-toggle-active';
      tabsBtn.className = 'btn btn-sm btn-toggle-inactive';
      
      document.getElementById('file').required = true;
    }
    
    async function showTabsMode() {
      document.getElementById('uploadMode').style.display = 'none';
      document.getElementById('tabsMode').style.display = 'block';
      
      const uploadBtn = document.getElementById('uploadToggle');
      const tabsBtn = document.getElementById('tabsToggle');
      
      uploadBtn.className = 'btn btn-sm btn-toggle-inactive';
      tabsBtn.className = 'btn btn-sm btn-toggle-active';
      
      document.getElementById('file').required = false;
      
      // Load existing Tabs credentials
      await loadTabsCredentials();
    }
    
    async function loadTabsCredentials() {
      try {
        const res = await fetch(`/api/merchant/${currentMerchantId}`);
        const data = await res.json();
        
        if (data.merchant && data.merchant.tabsApiKey) {
          document.getElementById('tabsApiKey').value = data.merchant.tabsApiKey;
          document.getElementById('tabsEnv').value = data.merchant.tabsEnv || 'dev';
          document.getElementById('tabsStatus').innerHTML = '<span style="color:#48bb78;">✅ API key configured</span>';
        } else {
          document.getElementById('tabsApiKey').value = '';
          document.getElementById('tabsEnv').value = 'dev';
          document.getElementById('tabsStatus').innerHTML = '<span style="color:#f6ad55;">⚠️ No API key saved - enter one above</span>';
        }
      } catch (error) {
        console.error('Failed to load Tabs credentials:', error);
      }
    }
    
    async function saveTabsCredentials() {
      const apiKey = document.getElementById('tabsApiKey').value.trim();
      const env = document.getElementById('tabsEnv').value;
      
      if (!apiKey) {
        document.getElementById('tabsStatus').innerHTML = '<span style="color:#f56565;">❌ Please enter an API key</span>';
        return;
      }
      
      try {
        const res = await fetch(`/api/merchant/${currentMerchantId}/tabs-credentials`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tabsApiKey: apiKey, tabsEnv: env })
        });
        
        if (res.ok) {
          document.getElementById('tabsStatus').innerHTML = '<span style="color:#48bb78;">✅ API key saved successfully!</span>';
        } else {
          const data = await res.json();
          throw new Error(data.error || 'Failed to save');
        }
      } catch (error) {
        document.getElementById('tabsStatus').innerHTML = `<span style="color:#f56565;">❌ ${error.message}</span>`;
      }
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Use merchant ID from landing page selection
      const merchantId = currentMerchantId;
      
      if (!merchantId) {
        showStatus('error', '❌ Merchant not selected');
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Analyzing...';
      showStatus('info', `⏳ Analyzing contract for ${merchantId}...`);
      results.innerHTML = '';

      try {
        let data;
        
        // Check if using Tabs mode or Upload mode
        const isTabsMode = document.getElementById('tabsMode').style.display !== 'none';
        
        if (isTabsMode) {
          // Extract from Tabs API
          const contractID = document.getElementById('tabsContractId').value.trim();
          if (!contractID) {
            showStatus('error', '❌ Please enter a Contract ID');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Analyze Contract';
            return;
          }
          
          const res = await fetch('/api/extract-from-tabs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              merchantId,
              contractID,
              model: document.getElementById('model').value,
              stage: currentStage,
              tabsEnv: 'prod' // Production mode always uses prod environment
            })
          });
          
          data = await res.json();
          if (!res.ok) throw new Error(data.error || data.hint || 'Request failed');
          
        } else {
          // Upload file
          const file = document.getElementById('file').files[0];
          if (!file) {
            showStatus('error', '❌ Please select a file');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Analyze Contract';
            return;
          }

          const formData = new FormData();
          formData.append('file', file);
          if (integrationMapping.length > 0) {
            formData.append('integration_mapping', JSON.stringify(integrationMapping));
          }

          const params = new URLSearchParams({
            model: document.getElementById('model').value,
            forceMulti: document.getElementById('forceMulti').value,
            runs: document.getElementById('runs').value,
            merchantId: merchantId,
            stage: currentStage,
            consistency: currentStage === 'production' ? (document.getElementById('consistencyValue')?.value || 'consistent') : 'consistent'
          });

          const res = await fetch(`/api/extract?${params}`, {
            method: 'POST',
            body: formData
          });

          data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Request failed');
        }

        currentData = data;
        
        // In demo mode, save original AI extraction before any user corrections
        if (currentStage === 'demo' && currentData.schedules) {
          currentData.schedules.forEach(schedule => {
            // Store a deep copy of the original AI extraction for comparison
            schedule.original_ai_extraction = {
              item_name: schedule.item_name,
              description: schedule.description,
              total_price: schedule.total_price,
              billing_type: schedule.billing_type,
              quantity: schedule.quantity,
              start_date: schedule.start_date,
              frequency_unit: schedule.frequency_unit,
              frequency_every: schedule.frequency_every,
              periods: schedule.periods,
              months_of_service: schedule.months_of_service,
              net_terms: schedule.net_terms,
              billing_timing: schedule.billing_timing,
              event_to_track: schedule.event_to_track,
              tiers: schedule.tiers ? JSON.parse(JSON.stringify(schedule.tiers)) : []
            };
          });
        }
        
        showStatus('success', `✅ Extracted ${data.schedules?.length || 0} schedule(s)`);
        renderResults(data);
        
        // Show guidance section only in demo mode
        if (currentStage === 'demo') {
        document.getElementById('guidanceSection').style.display = 'block';
        document.getElementById('merchantName').textContent = merchantId;
          // Show MIS upload in demo mode
          document.getElementById('misUploadContainer').style.display = 'block';
        } else {
          document.getElementById('guidanceSection').style.display = 'none';
        }
        
      } catch (error) {
        showStatus('error', '❌ ' + error.message);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Analyze Contract';
      }
    });

    function showStatus(type, message) {
      status.className = `alert alert-${type} show`;
      status.textContent = message;
    }

    function toggleSchedule(index) {
      document.getElementById(`schedule-${index}`).classList.toggle('open');
    }

    function renderResults(data) {
      if (!data.schedules || data.schedules.length === 0) {
        results.innerHTML = '<div class="card"><div class="card-body" style="text-align:center;color:#718096;">No schedules found</div></div>';
        
        // Show "Add Schedule" button even if no schedules in demo mode
        if (currentStage === 'demo') {
          results.innerHTML += `
            <div style="text-align:center;margin-top:1rem;">
              <button type="button" class="btn btn-success" onclick="addNewSchedule()" style="font-size:1rem;padding:0.75rem 1.5rem;">
                ➕ Add New Revenue Schedule
              </button>
            </div>
          `;
        }
        return;
      }

      results.innerHTML = '';
      
      // Add simple header
      const headerDiv = document.createElement('div');
      headerDiv.className = 'card';
      
      if (currentStage === 'demo') {
        headerDiv.innerHTML = `
          <div class="card-body" style="padding:1rem;">
            <h3 style="color:#3b82f6;margin:0;font-size:1rem;font-weight:600;">Demo Mode - Training Session</h3>
            <p style="color:var(--text-secondary);margin:0.375rem 0 0 0;font-size:0.813rem;">Review AI results, make corrections, and add instructions</p>
          </div>
        `;
      } else {
        headerDiv.innerHTML = `
          <div class="card-body" style="padding:1rem;">
            <h3 style="color:#166534;margin:0;font-size:1rem;font-weight:600;">Production Mode</h3>
            <p style="color:var(--text-secondary);margin:0.375rem 0 0 0;font-size:0.813rem;">Using saved training data (read-only)</p>
          </div>
        `;
      }
      
      results.appendChild(headerDiv);
      
      data.schedules.forEach((schedule, index) => {
        const item = document.createElement('div');
        item.className = 'schedule-item';
        item.id = `schedule-${index}`;
        
        const conf = schedule.integration_match_confidence || 'none';
        const price = (schedule.total_price || 0).toLocaleString('en-US', { minimumFractionDigits: 2 });
        const evidenceCount = schedule.evidence?.length || 0;

        item.innerHTML = `
          <div class="schedule-header" onclick="toggleSchedule(${index})">
            <div class="toggle-icon"><i class="bi bi-chevron-right"></i></div>
            <div class="schedule-info">
              <div class="schedule-name">${esc(schedule.item_name || 'Unnamed')}</div>
              <div class="schedule-meta">$${price} • ${schedule.billing_type || 'N/A'} • ${evidenceCount} evidence</div>
            </div>
            <div class="badge badge-${conf}">${conf.toUpperCase()}</div>
          </div>

          <div class="schedule-content">
            ${schedule.extraction_reasoning ? `
              <div class="section">
                <div class="section-title">AI Reasoning</div>
                <div class="reasoning-box">
                  <div class="reasoning-text">${esc(schedule.extraction_reasoning)}</div>
                </div>
              </div>
            ` : ''}

            <div class="section">
              <div class="instructions-toggle" onclick="toggleEvidence(${index})">
                <span>Evidence from Contract</span>
                <span class="toggle-icon"><i class="bi bi-chevron-down"></i></span>
              </div>
              <div id="evidence-${index}" class="instructions-content">
                ${schedule.evidence && schedule.evidence.length > 0 ? 
                  schedule.evidence.map(ev => `
                    <div class="evidence-box">
                      <div class="evidence-header">Page ${ev.page || '?'} • ${ev.field_supported || 'General'}</div>
                      <div class="evidence-text">${esc(ev.snippet || 'No snippet')}</div>
                    </div>
                  `).join('') : 
                  '<p style="color:#a0aec0;text-align:center;padding:1rem;">No evidence provided by AI</p>'
                }
              </div>
            </div>

            <div class="section ${currentStage === 'production' ? 'read-only-view' : ''}">
              <div class="section-title">${currentStage === 'demo' ? 'Edit & Add Instructions' : 'Extracted Fields (Read-Only)'}</div>
              
              <!-- Row 1: Item Name & Description -->
              <div class="form-row">
                <div style="grid-column: span 2;">
                  <label>Item Name</label>
                  <input type="text" value="${esc(schedule.item_name || '')}" data-field="item_name" data-index="${index}" ${currentStage === 'production' ? 'readonly' : ''}>
                </div>
                </div>
              
              <div class="form-row">
                <div style="grid-column: span 2;">
                  <label>Item Description (optional)</label>
                  <textarea data-field="description" data-index="${index}" ${currentStage === 'production' ? 'readonly' : ''} style="min-height:60px;padding:0.5rem 0.75rem;resize:vertical;">${esc(schedule.description || '')}</textarea>
                </div>
              </div>
              
              <!-- Row 2: Billing Type, Total Price, Quantity -->
              <div class="form-row">
                <div>
                  <label>Billing Type</label>
                  <select data-field="billing_type" data-index="${index}" onchange="toggleBillingFields(${index})" ${currentStage === 'production' ? 'disabled' : ''}>
                    <option ${schedule.billing_type === 'Flat price' ? 'selected' : ''}>Flat price</option>
                    <option ${schedule.billing_type === 'Unit price' ? 'selected' : ''}>Unit price</option>
                    <option ${schedule.billing_type === 'Tier flat price' ? 'selected' : ''}>Tier flat price</option>
                    <option ${schedule.billing_type === 'Tier unit price' ? 'selected' : ''}>Tier unit price</option>
                  </select>
                </div>
                <div>
                  <label>Total Price</label>
                  <input type="number" step="0.01" value="${schedule.total_price || 0}" data-field="total_price" data-index="${index}" ${currentStage === 'production' ? 'readonly' : ''}>
                </div>
                <div>
                  <label>Quantity</label>
                  <input type="number" value="${schedule.quantity || 1}" data-field="quantity" data-index="${index}" ${currentStage === 'production' ? 'readonly' : ''}>
                </div>
              </div>
              
              <!-- Row 3: Start Date, # Periods, Frequency -->
              <div class="form-row">
                <div>
                  <label>Start Date</label>
                  <input type="date" value="${schedule.start_date || ''}" data-field="start_date" data-index="${index}" onchange="calculateEndDate(${index})" ${currentStage === 'production' ? 'readonly' : ''}>
                </div>
                <div>
                  <label># Periods</label>
                  <input type="number" value="${schedule.periods || 1}" data-field="periods" data-index="${index}" ${currentStage === 'production' ? 'readonly' : ''}>
                </div>
                <div>
                  <label>Frequency</label>
                  <div style="display:flex;gap:0.5rem;align-items:center;">
                    <span style="font-size:0.875rem;">every</span>
                    <input type="number" value="${schedule.frequency_every || 1}" data-field="frequency_every" data-index="${index}" style="width:60px;" ${currentStage === 'production' ? 'readonly' : ''}>
                    <select data-field="frequency_unit" data-index="${index}" style="flex:1;" ${currentStage === 'production' ? 'disabled' : ''}>
                      <option ${schedule.frequency_unit === 'None' ? 'selected' : ''}>None</option>
                      <option ${schedule.frequency_unit === 'Day(s)' ? 'selected' : ''}>Day(s)</option>
                      <option ${schedule.frequency_unit === 'Week(s)' ? 'selected' : ''}>Week(s)</option>
                      <option ${schedule.frequency_unit === 'Month(s)' ? 'selected' : ''}>Month(s)</option>
                      <option ${schedule.frequency_unit === 'Year(s)' ? 'selected' : ''}>Year(s)</option>
                      <option ${schedule.frequency_unit === 'Semi_month(s)' ? 'selected' : ''}>Semi_month(s)</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <!-- Row 4: Calculated End Date, Net Terms, Billing Timing -->
              <div class="form-row">
                <div>
                  <label>Calculated End Date</label>
                  <input type="date" id="calc-end-${index}" value="${(() => {
                    if (!schedule.start_date) return '';
                    const start = new Date(schedule.start_date);
                    if (isNaN(start.getTime())) return '';
                    const end = new Date(start);
                    end.setMonth(end.getMonth() + (parseInt(schedule.months_of_service) || 12));
                    return end.toISOString().split('T')[0];
                  })()}" readonly style="background:#f7fafc;cursor:not-allowed;">
                </div>
                <div>
                  <label>Net Terms (days)</label>
                  <input type="number" value="${schedule.net_terms || 0}" data-field="net_terms" data-index="${index}" ${currentStage === 'production' ? 'readonly' : ''}>
                </div>
                <div>
                  <label>Billing Timing</label>
                  <select data-field="billing_timing" data-index="${index}" ${currentStage === 'production' ? 'disabled' : ''}>
                    <option value="first" ${!schedule.billing_timing || schedule.billing_timing === 'first' || schedule.arrears === false ? 'selected' : ''}>Bill first of period</option>
                    <option value="last" ${schedule.billing_timing === 'last' || schedule.arrears === true ? 'selected' : ''}>Bill last of period</option>
                    <option value="next_period" ${schedule.billing_timing === 'next_period' ? 'selected' : ''}>Bill first of next period</option>
                  </select>
                </div>
              </div>
              
              <div class="form-row">
                <div>
                  <label>Months of Service (Service Term)</label>
                  <input type="number" value="${schedule.months_of_service || 12}" data-field="months_of_service" data-index="${index}" onchange="calculateEndDate(${index})" ${currentStage === 'production' ? 'readonly' : ''}>
                </div>
              </div>
              
              <!-- Event to Track (for Unit/Tier pricing only) -->
              <div id="event-track-${index}" class="form-row" style="display:${schedule.billing_type !== 'Flat price' ? 'grid' : 'none'};">
                <div style="grid-column: span 2;">
                  <label>Event to Track (for usage/overage)</label>
                  <input type="text" value="${esc(schedule.event_to_track || (schedule.item_name ? schedule.item_name + ' overage' : ''))}" data-field="event_to_track" data-index="${index}" placeholder="${esc((schedule.item_name || 'Item') + ' overage')}" ${currentStage === 'production' ? 'readonly' : ''}>
                </div>
              </div>
              
              <!-- Tier Pricing (for Tier pricing only) - Simplified Display -->
              <div id="tier-section-${index}" style="display:${schedule.billing_type && (schedule.billing_type === 'Tier flat price' || schedule.billing_type === 'Tier unit price') ? 'block' : 'none'};margin-top:1rem;">
                <div class="form-row">
                  <div style="grid-column: span 2;">
                    <label>Tiers</label>
                    <div style="display:flex;gap:0.5rem;flex-wrap:wrap;padding:0.75rem;background:var(--bg-subtle);border-radius:8px;border:1px solid var(--border);">
                      ${(schedule.tiers || []).map((tier, tierIdx) => `
                        <span class="badge" style="padding:0.5rem 0.875rem;font-size:0.875rem;background:var(--primary);color:white;">Tier ${tierIdx + 1}</span>
                      `).join('') || '<span style="color:var(--text-secondary);font-size:0.813rem;">No tiers</span>'}
                    </div>
                  </div>
                </div>
              </div>

              ${currentStage === 'demo' ? `
                <!-- Collapsible Instructions Section -->
                <div class="instructions-toggle" onclick="toggleInstructions(${index})">
                  <span>Field-Specific Guidance & Instructions</span>
                  <span class="toggle-icon"><i class="bi bi-chevron-down"></i></span>
                </div>
                <div id="instructions-${index}" class="instructions-content">
                  <div style="display:grid;gap:1rem;">
                    <div>
                      <label style="font-weight:600;color:#2d3748;">Item Name - Where to find?</label>
                      <textarea data-instruction="item_name" data-index="${index}" placeholder="e.g., Look for product/service name in Schedule A">${esc(schedule.instruction_item_name || '')}</textarea>
                    </div>
                    <div>
                      <label style="font-weight:600;color:#2d3748;">Description - Where to find?</label>
                      <textarea data-instruction="description" data-index="${index}" placeholder="e.g., Additional details section, look for community/location names">${esc(schedule.instruction_description || '')}</textarea>
                    </div>
                    <div>
                      <label style="font-weight:600;color:#2d3748;">Total Price - Where to find?</label>
                      <textarea data-instruction="total_price" data-index="${index}" placeholder="e.g., Total Amount column, exclude taxes">${esc(schedule.instruction_total_price || '')}</textarea>
                    </div>
                    <div>
                      <label style="font-weight:600;color:#2d3748;">Billing Type - How to determine?</label>
                      <textarea data-instruction="billing_type" data-index="${index}" placeholder="e.g., Flat unless per-unit or tiered pricing">${esc(schedule.instruction_billing_type || '')}</textarea>
                    </div>
                    <div>
                      <label style="font-weight:600;color:#2d3748;">Quantity - Where to find?</label>
                      <textarea data-instruction="quantity" data-index="${index}" placeholder="e.g., Number of units/seats, typically 1 for flat pricing">${esc(schedule.instruction_quantity || '')}</textarea>
                    </div>
                    <div>
                      <label style="font-weight:600;color:#2d3748;">Start Date - Where to find?</label>
                      <textarea data-instruction="start_date" data-index="${index}" placeholder="e.g., Effective Date or Service Start Date">${esc(schedule.instruction_start_date || '')}</textarea>
                    </div>
                    <div>
                      <label style="font-weight:600;color:#2d3748;">Frequency - Where to find?</label>
                      <textarea data-instruction="frequency_unit" data-index="${index}" placeholder="e.g., Monthly, Quarterly, Annual billing">${esc(schedule.instruction_frequency_unit || '')}</textarea>
                    </div>
                    <div>
                      <label style="font-weight:600;color:#2d3748;"># Periods - Where to find?</label>
                      <textarea data-instruction="periods" data-index="${index}" placeholder="e.g., Number of billing cycles">${esc(schedule.instruction_periods || '')}</textarea>
                    </div>
                    <div>
                      <label style="font-weight:600;color:#2d3748;">Months of Service - Where to find?</label>
                      <textarea data-instruction="months_of_service" data-index="${index}" placeholder="e.g., Contract term (12, 24, 36 months)">${esc(schedule.instruction_months_of_service || '')}</textarea>
                    </div>
                    <div>
                      <label style="font-weight:600;color:#2d3748;">Net Terms - Where to find?</label>
                      <textarea data-instruction="net_terms" data-index="${index}" placeholder="e.g., Net 30, Net 60, Due on receipt">${esc(schedule.instruction_net_terms || '')}</textarea>
                    </div>
                    <div>
                      <label style="font-weight:600;color:#2d3748;">Billing Timing - Where to find?</label>
                      <textarea data-instruction="billing_timing" data-index="${index}" placeholder="e.g., Billed in advance / arrears / usage-based">${esc(schedule.instruction_billing_timing || '')}</textarea>
                    </div>
                    <div>
                      <label style="font-weight:600;color:#2d3748;">Event to Track - Where to find?</label>
                      <textarea data-instruction="event_to_track" data-index="${index}" placeholder="Usually: item name + ' overage'">${esc(schedule.instruction_event_to_track || '')}</textarea>
                    </div>
                </div>
              </div>

              <div class="actions">
                <button type="button" class="btn btn-sm" style="background:#718096;color:white;" onclick="copyJSON(${index})">
                  <i class="bi bi-clipboard me-1"></i> Copy JSON
                </button>
                <button type="button" class="btn btn-sm" style="background:#f87171;color:white;" onclick="deleteSchedule(${index})">
                  <i class="bi bi-trash me-1"></i> Delete Schedule
                </button>
              </div>
              ` : ''}
            </div>
          </div>
        `;

        results.appendChild(item);
        
        // Add small "Add New Revenue Schedule" button after each schedule in demo mode
        if (currentStage === 'demo' && index === data.schedules.length - 1) {
          const addButton = document.createElement('div');
          addButton.style.cssText = 'text-align:center;margin:1rem 0;';
          addButton.innerHTML = `
            <button type="button" class="btn btn-primary btn-sm" onclick="addNewSchedule()" style="font-size:0.75rem;padding:0.5rem 1rem;">
              <i class="bi bi-plus-circle me-1"></i> Add New Revenue Schedule
            </button>
          `;
          results.appendChild(addButton);
        }
      });
      
      // Add bottom action buttons (fixed bottom-right corner)
      let bottomActions = document.querySelector('.bottom-actions');
      if (!bottomActions) {
        bottomActions = document.createElement('div');
        bottomActions.className = 'bottom-actions';
        document.body.appendChild(bottomActions);
      }
      
      bottomActions.innerHTML = '';
      
      if (currentStage === 'demo') {
        bottomActions.innerHTML = `
          <button type="button" class="btn btn-success" onclick="saveDemoSession()">
            <i class="bi bi-save me-1"></i> Save Training
          </button>
          ${data.pdf_session_id ? `<button type="button" class="btn btn-primary" onclick="viewPDF('${data.pdf_session_id}')">
            <i class="bi bi-file-pdf me-1"></i> View PDF
          </button>` : ''}
        `;
      } else {
        // Production mode buttons
        bottomActions.innerHTML = `
          ${data.pdf_session_id ? `<button type="button" class="btn btn-primary" onclick="viewPDF('${data.pdf_session_id}')">
            <i class="bi bi-file-pdf me-1"></i> View PDF
          </button>` : ''}
          <button type="button" class="btn btn-success btn-sm" onclick="viewGarageOutput()">
            <i class="bi bi-code-square me-1"></i> View Garage Output
          </button>
        `;
      }
    }
    
    function toggleInstructions(index) {
      const content = document.getElementById(`instructions-${index}`);
      const toggle = content.previousElementSibling;
      content.classList.toggle('show');
      toggle.classList.toggle('open');
    }
    
    function toggleEvidence(index) {
      const content = document.getElementById(`evidence-${index}`);
      const toggle = content.previousElementSibling;
      content.classList.toggle('show');
      toggle.classList.toggle('open');
    }

    function esc(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function applyCorrections(index) {
      // Save regular fields and instructions
      const inputs = document.querySelectorAll(`[data-index="${index}"]`);
      inputs.forEach(input => {
        const field = input.getAttribute('data-field');
        const instruction = input.getAttribute('data-instruction');
        
        if (field && field !== 'frequency_display') {
          let value = input.value;
          if (input.type === 'number') {
            value = parseFloat(value) || 0;
          } else if (input.tagName === 'SELECT') {
            value = input.value;
          } else if (input.tagName === 'TEXTAREA') {
            value = input.value;
          }
          
          // Handle billing_timing specially (convert to arrears boolean)
          if (field === 'billing_timing') {
            currentData.schedules[index].billing_timing = value;
            currentData.schedules[index].arrears = (value === 'last');
          } else {
            currentData.schedules[index][field] = value;
          }
        }
        
        if (instruction) {
          currentData.schedules[index][`instruction_${instruction}`] = input.value.trim();
        }
      });
      
      // Save tier data
      const tierInputs = document.querySelectorAll(`[data-tier][data-index="${index}"]`);
      const tiers = {};
      tierInputs.forEach(input => {
        const tierField = input.getAttribute('data-tier');
        const tierIdx = parseInt(input.getAttribute('data-tier-idx'));
        
        if (!tiers[tierIdx]) {
          tiers[tierIdx] = {};
        }
        
        let value = input.value;
        if (input.type === 'number') {
          value = parseFloat(value) || 0;
        }
        tiers[tierIdx][tierField] = value;
      });
      
      // Update tiers array
      if (Object.keys(tiers).length > 0) {
        currentData.schedules[index].tiers = Object.values(tiers);
      }
      
      showStatus('success', `✅ Changes and instructions saved for item ${index + 1}`);
    }
    
    // Show confirmation modal
    function saveDemoSession() {
      console.log('=== saveDemoSession called ===');
      console.log('currentMerchantId:', currentMerchantId);
      console.log('currentData:', currentData);
      
      if (!currentMerchantId) {
        showStatus('error', '❌ No merchant selected');
        return;
      }
      
      if (!currentData || !currentData.schedules || currentData.schedules.length === 0) {
        showStatus('error', '❌ No data to save');
        return;
      }
      
      // Show confirmation modal
      const modal = document.getElementById('confirmationModal');
      modal.classList.add('show');
    }
    
    function closeConfirmation() {
      const modal = document.getElementById('confirmationModal');
      modal.classList.remove('show');
    }
    
    // Actually save after confirmation
    async function confirmSave() {
      closeConfirmation();
      
      if (!currentMerchantId) {
        showStatus('error', '❌ No merchant selected');
        return;
      }
      
      if (!currentData || !currentData.schedules || currentData.schedules.length === 0) {
        showStatus('error', '❌ No data to save');
        return;
      }
      
      // First apply any pending corrections
      currentData.schedules.forEach((_, index) => {
        const inputs = document.querySelectorAll(`[data-index="${index}"]`);
        inputs.forEach(input => {
          const field = input.getAttribute('data-field');
          const instruction = input.getAttribute('data-instruction');
          
          if (field && field !== 'frequency_display') {
        let value = input.value;
        if (input.type === 'number') value = parseFloat(value) || 0;
        currentData.schedules[index][field] = value;
          }
          
          if (instruction) {
            currentData.schedules[index][`instruction_${instruction}`] = input.value.trim();
          }
        });
      });
      
      const demoSession = {
        merchant_id: currentMerchantId,
        created_at: new Date().toISOString(),
        pdf_session_id: currentData.pdf_session_id, // Include PDF session ID so backend can save the PDF
        schedules: currentData.schedules.map(s => ({
          // Corrected values (final ground truth)
          item_name: s.item_name,
          description: s.description,
          total_price: s.total_price,
          billing_type: s.billing_type,
          quantity: s.quantity,
          start_date: s.start_date,
          frequency_unit: s.frequency_unit,
          frequency_every: s.frequency_every,
          periods: s.periods,
          months_of_service: s.months_of_service,
          net_terms: s.net_terms,
          billing_timing: s.billing_timing,
          arrears: s.arrears,
          event_to_track: s.event_to_track,
          tiers: s.tiers || [],
          
          // Original AI extraction (before corrections) - for tracking what was wrong
          original_ai_extraction: s.original_ai_extraction || null,
          
          // Instructions for finding these fields
          instruction_item_name: s.instruction_item_name || '',
          instruction_description: s.instruction_description || '',
          instruction_total_price: s.instruction_total_price || '',
          instruction_billing_type: s.instruction_billing_type || '',
          instruction_quantity: s.instruction_quantity || '',
          instruction_start_date: s.instruction_start_date || '',
          instruction_frequency_unit: s.instruction_frequency_unit || '',
          instruction_periods: s.instruction_periods || '',
          instruction_months_of_service: s.instruction_months_of_service || '',
          instruction_net_terms: s.instruction_net_terms || '',
          instruction_billing_timing: s.instruction_billing_timing || '',
          instruction_event_to_track: s.instruction_event_to_track || '',
          
          // Keep evidence for reference
          evidence: s.evidence || [],
          
          // Keep extraction reasoning from AI
          extraction_reasoning: s.extraction_reasoning || ''
        })),
        system_prompt_used: currentData.system_prompt
        // Note: garage_revenue_schedules will be regenerated on backend from corrected schedules
      };
      
      console.log('Sending demo session:', demoSession);
      
      try {
        const res = await fetch('/api/save-demo-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(demoSession)
        });
        
        console.log('Response status:', res.status);
        const responseData = await res.json();
        console.log('Response data:', responseData);
        
        if (res.ok) {
          showStatus('success', `✅ Demo session saved for ${currentMerchantId}! (${responseData.schedules_count} schedules)`);
          // Reload merchants to update the list
          await loadMerchants();
        } else {
          throw new Error(responseData.error || 'Save failed');
        }
      } catch (error) {
        console.error('Save error:', error);
        showStatus('error', '❌ Failed to save demo session: ' + error.message);
      }
    }

    function copyJSON(index) {
      navigator.clipboard.writeText(JSON.stringify(currentData.schedules[index], null, 2))
        .then(() => showStatus('success', '✅ Copied'))
        .catch(() => showStatus('error', '❌ Copy failed'));
    }

    // Add a new blank revenue schedule (Demo mode only)
    function addNewSchedule() {
      if (currentStage !== 'demo') {
        showStatus('error', '❌ Can only add schedules in Demo mode');
        return;
      }
      
      // Create a blank schedule
      const newSchedule = {
        item_name: '',
        description: '',
        total_price: 0,
        billing_type: 'Flat price',
        quantity: 1,
        start_date: '',
        frequency_unit: 'Month(s)',
        frequency_every: 1,
        periods: 1,
        months_of_service: 12,
        net_terms: 0,
        billing_timing: 'first',
        arrears: false,
        event_to_track: '',
        tiers: [],
        evidence: [],
        // Empty instructions
        instruction_item_name: '',
        instruction_total_price: '',
        instruction_billing_type: '',
        instruction_quantity: '',
        instruction_start_date: '',
        instruction_frequency_unit: '',
        instruction_periods: '',
        instruction_months_of_service: '',
        instruction_net_terms: '',
        instruction_billing_timing: '',
        instruction_event_to_track: ''
      };
      
      // Add to current data
      if (!currentData) {
        currentData = { schedules: [], pdf_session_id: null };
      }
      
      if (!currentData.schedules) {
        currentData.schedules = [];
      }
      
      currentData.schedules.push(newSchedule);
      
      // Re-render
      renderResults(currentData);
      
      // Scroll to the new schedule
      setTimeout(() => {
        const newIndex = currentData.schedules.length - 1;
        const newScheduleEl = document.getElementById(`schedule-${newIndex}`);
        if (newScheduleEl) {
          newScheduleEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }, 100);
      
      showStatus('success', `✅ Added new revenue schedule #${currentData.schedules.length}`);
    }
    
    // Delete a revenue schedule (Demo mode only)
    function deleteSchedule(index) {
      if (currentStage !== 'demo') {
        showStatus('error', '❌ Can only delete schedules in Demo mode');
        return;
      }
      
      if (!currentData || !currentData.schedules || currentData.schedules.length === 0) {
        showStatus('error', '❌ No schedules to delete');
        return;
      }
      
      if (index < 0 || index >= currentData.schedules.length) {
        showStatus('error', '❌ Invalid schedule index');
        return;
      }
      
      const itemName = currentData.schedules[index].item_name || 'Unnamed Item';
      
      if (confirm(`Are you sure you want to delete "${itemName}"?\n\nThis will remove it from the training session when you save.`)) {
        // Remove the schedule
        currentData.schedules.splice(index, 1);
        
        // Re-render
        renderResults(currentData);
        
        showStatus('success', `✅ Deleted "${itemName}"`);
      }
    }

    function viewPDF(sessionId) {
      if (!sessionId) {
        showStatus('error', '❌ PDF not available');
        return;
      }
      // Open PDF in inline modal
      const modal = document.getElementById('pdfModal');
      const iframe = document.getElementById('pdfViewer');
      iframe.src = `/api/view-pdf/${sessionId}`;
      modal.classList.add('show');
      document.body.style.overflow = 'hidden'; // Prevent background scrolling
    }
    
    function closePDFModal(event) {
      if (event && event.target !== event.currentTarget && !event.target.classList.contains('pdf-modal-close')) {
        return; // Don't close if clicking inside modal content
      }
      const modal = document.getElementById('pdfModal');
      const iframe = document.getElementById('pdfViewer');
      modal.classList.remove('show');
      iframe.src = ''; // Clear iframe
      document.body.style.overflow = ''; // Restore scrolling
    }
    
    function viewGarageOutput() {
      if (!currentData || !currentData.garage_revenue_schedules) {
        showStatus('error', '❌ No garage output available');
        return;
      }
      const modal = document.getElementById('garageOutputModal');
      const pre = document.getElementById('garageOutputJSON');
      pre.textContent = JSON.stringify(currentData.garage_revenue_schedules, null, 2);
      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }
    
    function closeGarageOutputModal(event) {
      if (event && event.target !== event.currentTarget && !event.target.classList.contains('pdf-modal-close')) {
        return;
      }
      const modal = document.getElementById('garageOutputModal');
      modal.classList.remove('show');
      document.body.style.overflow = '';
    }
    
    // Demo & Configs Modal Functions
    function openDemoConfigsModal() {
      if (!currentMerchantId) {
        showStatus('error', '❌ Please select a merchant first');
        return;
      }
      document.getElementById('demoAuthModal').style.display = 'flex';
      document.getElementById('demoApiKey').value = '';
      document.getElementById('demoAuthError').style.display = 'none';
    }
    
    function closeDemoAuthModal(event) {
      if (event && event.target.id !== 'demoAuthModal' && !event.target.classList.contains('pdf-modal-close')) {
        return;
      }
      document.getElementById('demoAuthModal').style.display = 'none';
    }
    
    async function authenticateDemoAccess(event) {
      event.preventDefault();
      
      const apiKey = document.getElementById('demoApiKey').value;
      const errorDiv = document.getElementById('demoAuthError');
      
      try {
        // Verify API key against merchant's stored key
        const res = await fetch(`/api/merchant/${currentMerchantId}`);
        const data = await res.json();
        
        if (!data.merchant) {
          errorDiv.textContent = 'Merchant not found';
          errorDiv.style.display = 'block';
          return;
        }
        
        // Check if API key matches (if merchant has one stored)
        if (data.merchant.tabsApiKey && data.merchant.tabsApiKey !== apiKey) {
          errorDiv.textContent = 'Invalid API key for this merchant';
          errorDiv.style.display = 'block';
          return;
        }
        
        // If no API key is stored yet, save this one with default 'prod' environment
        if (!data.merchant.tabsApiKey) {
          await fetch(`/api/merchant/${currentMerchantId}/tabs-credentials`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tabs_api_key: apiKey, tabs_env: 'prod' })
          });
        }
        
        // Success - redirect to settings page
        window.location.href = `/settings.html?merchant=${encodeURIComponent(currentMerchantId)}&verified=true`;
        
      } catch (error) {
        console.error('Authentication error:', error);
        errorDiv.textContent = 'Authentication failed: ' + error.message;
        errorDiv.style.display = 'block';
      }
    }
    
    // Calculate end date from start date + months (for rendering)
    function calculateEndDate(startDate, months) {
      if (!startDate) return '';
      const start = new Date(startDate);
      if (isNaN(start.getTime())) return '';
      const end = new Date(start);
      end.setMonth(end.getMonth() + (parseInt(months) || 12));
      return end.toISOString().split('T')[0];
    }
    
    // Event handler version that updates the UI
    window.calculateEndDate = function(index) {
      const startInput = document.querySelector(`[data-field="start_date"][data-index="${index}"]`);
      const monthsInput = document.querySelector(`[data-field="months_of_service"][data-index="${index}"]`);
      const endInput = document.getElementById(`calc-end-${index}`);
      
      if (!startInput || !monthsInput || !endInput) return;
      
      const startDate = startInput.value;
      const months = parseInt(monthsInput.value) || 12;
      
      if (startDate) {
        const calculatedEnd = calculateEndDate(startDate, months);
        endInput.value = calculatedEnd;
        
        // Update in currentData
        if (currentData && currentData.schedules[index]) {
          currentData.schedules[index].calculated_end_date = calculatedEnd;
        }
      }
    };
    
    // Toggle billing-type-specific fields (event to track, tier pricing)
    function toggleBillingFields(index) {
      const billingTypeSelect = document.querySelector(`[data-field="billing_type"][data-index="${index}"]`);
      const billingType = billingTypeSelect ? billingTypeSelect.value : 'Flat price';
      
      // Show/hide Event to Track
      const eventSection = document.getElementById(`event-track-${index}`);
      if (eventSection) {
        eventSection.style.display = (billingType !== 'Flat price') ? 'grid' : 'none';
        
        // Auto-populate event to track if empty
        if (billingType !== 'Flat price') {
          const eventInput = eventSection.querySelector(`[data-field="event_to_track"]`);
          const itemInput = document.querySelector(`[data-field="item_name"][data-index="${index}"]`);
          if (eventInput && itemInput && !eventInput.value.trim()) {
            eventInput.value = itemInput.value + ' overage';
          }
        }
      }
      
      // Show/hide Tier Pricing
      const tierSection = document.getElementById(`tier-section-${index}`);
      if (tierSection) {
        const showTiers = (billingType === 'Tier flat price' || billingType === 'Tier unit price');
        tierSection.style.display = showTiers ? 'block' : 'none';
      }
      
      // Update in currentData
      if (currentData && currentData.schedules[index]) {
        currentData.schedules[index].billing_type = billingType;
      }
    }
    
    // Add new tier to tier pricing
    function addTier(index) {
      if (!currentData || !currentData.schedules[index]) return;
      
      if (!currentData.schedules[index].tiers) {
        currentData.schedules[index].tiers = [];
      }
      
      const tierIdx = currentData.schedules[index].tiers.length;
      const newTier = {
        tier_name: `Tier ${tierIdx + 1}`,
        price: 0,
        applied_when: '',
        min_quantity: 0
      };
      
      currentData.schedules[index].tiers.push(newTier);
      
      // Re-render just this tier
      const container = document.getElementById(`tiers-container-${index}`);
      const billingType = currentData.schedules[index].billing_type;
      
      if (container) {
        const tierHtml = `
          <div class="form-row" style="background:white;padding:0.75rem;border-radius:4px;margin-bottom:0.5rem;border:1px solid #e2e8f0;">
            <div>
              <label>Tier ${tierIdx + 1} Name</label>
              <input type="text" value="${newTier.tier_name}" data-tier="tier_name" data-tier-idx="${tierIdx}" data-index="${index}">
            </div>
            <div>
              <label>Price ${billingType === 'Tier unit price' ? '(per unit)' : '(flat)'}</label>
              <input type="number" step="0.01" value="${newTier.price}" data-tier="price" data-tier-idx="${tierIdx}" data-index="${index}">
            </div>
            <div>
              <label>Applied When (condition)</label>
              <input type="text" value="${newTier.applied_when}" data-tier="applied_when" data-tier-idx="${tierIdx}" data-index="${index}" placeholder="e.g., 0-10, 10+">
            </div>
            <div>
              <label>Min Quantity</label>
              <input type="number" value="${newTier.min_quantity}" data-tier="min_quantity" data-tier-idx="${tierIdx}" data-index="${index}">
            </div>
          </div>
        `;
        
        // Remove "no tiers" message if exists
        const noTiersMsg = container.querySelector('p');
        if (noTiersMsg) noTiersMsg.remove();
        
        container.insertAdjacentHTML('beforeend', tierHtml);
        showStatus('success', `✅ Tier ${tierIdx + 1} added`);
      }
    }
    
    // Initialize
    loadMerchants();
    handleStageChange();
  </script>
  
  <!-- Bootstrap 5 JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
